<div class="checkout-container">
  <header class="checkout-header">
    <h1>Finalizar Compra</h1>
    <div class="progress-bar">
      <div class="progress-steps">
        <div 
          *ngFor="let step of [1,2,3,4]; let i = index" 
          class="step"
          [class.active]="currentStep === step"
          [class.completed]="currentStep > step"
          (click)="goToStep(step)">
          <fa-icon [icon]="getStepIcon(step)" *ngIf="getStepIcon(step)"></fa-icon>
          <span>{{ getStepTitle(step) }}</span>
        </div>
      </div>
    </div>
  </header>

  <aside class="cart-summary">
    <h3>Resumo do Pedido</h3>
    <div class="summary-content">
      <div class="items-list">
        <div *ngFor="let item of cartSummary.items" class="item">
          <span class="item-name">{{ item.titulo }}</span>
          <span class="item-qty">x{{ item.quantidade }}</span>
          <span class="item-price">{{ formatCurrency(item.valorUnitario * item.quantidade) }}</span>
        </div>
      </div>
      
      <div class="summary-totals">
        <div class="total-line">
          <span>Subtotal:</span>
          <span>{{ formatCurrency(cartSummary.subtotal) }}</span>
        </div>
        
        <div class="total-line" *ngIf="cartSummary.discount > 0">
          <span>Desconto:</span>
          <span class="discount">-{{ formatCurrency(cartSummary.discount) }}</span>
        </div>
        
        <div class="total-line">
          <span>Frete:</span>
          <span>{{ formatCurrency(cartSummary.shipping) }}</span>
        </div>
        
        <div class="total-line total">
          <span>Total:</span>
          <span>{{ formatCurrency(cartSummary.total) }}</span>
        </div>
      </div>

      <div class="applied-coupons" *ngIf="cartSummary.coupons.length > 0">
        <h4>Cupons Aplicados:</h4>
        <div *ngFor="let coupon of cartSummary.coupons" class="coupon-item">
          <span>{{ coupon.code }}</span>
          <button type="button" (click)="removeCoupon(coupon.id)" class="remove-coupon">
            ×
          </button>
        </div>
      </div>
    </div>
  </aside>

  <main class="checkout-content">
    <div *ngIf="currentStep === 1" class="step-content">
      <h2>Selecionar Cliente</h2>
      <form [formGroup]="checkoutForm">
        <div class="form-group">
          <label for="clientId">Cliente:</label>
          <select id="clientId" formControlName="clientId" (change)="onClientChange()">
            <option value="">Selecione um cliente...</option>
            <option *ngFor="let client of clients" [value]="client.id">
              {{ client.nome }} - {{ client.email }}
            </option>
          </select>
        </div>
      </form>
    </div>

    <div *ngIf="currentStep === 2" class="step-content">
      <h2>Endereço de Entrega</h2>
      
      <div class="existing-addresses">
        <h3>Endereços Cadastrados</h3>
        <div class="address-list">
          <div *ngFor="let address of clientAddresses" class="address-card">
            <input 
              type="radio" 
              [id]="'address-' + address.id"
              [value]="address.id"
              formControlName="deliveryAddressId"
              (change)="onAddressChange()">
            <label [for]="'address-' + address.id">
              <strong>{{ address.name }}</strong><br>
              {{ address.street }}, {{ address.number }}<br>
              <span *ngIf="address.complement">{{ address.complement }}<br></span>
              {{ address.neighborhood }} - {{ address.city }}/{{ address.state }}<br>
              CEP: {{ formatZipCode(address.zipCode) }}
            </label>
          </div>
          
          <div class="address-card add-new-address-card" *ngIf="clientAddresses.length === 0 || checkoutForm.get('deliveryAddressId')?.value === 'NEW_ADDRESS'">
            <input 
              type="radio" 
              id="address-new"
              value="NEW_ADDRESS"
              formControlName="deliveryAddressId"
              (change)="onAddressChange()">
            <label for="address-new">
              <strong>➕ Adicionar novo endereço</strong>
            </label>
            <small class="help-text" *ngIf="checkoutForm.get('deliveryAddressId')?.value === 'NEW_ADDRESS'">
              Você será redirecionado para adicionar um novo endereço no seu perfil. Após adicionar, volte ao checkout.
            </small>
          </div>
        </div>
      </div>
        <h3>Adicionar Novo Endereço</h3>
        <form [formGroup]="addressForm">
          <div class="form-row">
            <div class="form-group">
              <label for="addressName">Nome do Endereço:</label>
              <input id="addressName" type="text" formControlName="name" placeholder="Ex: Casa, Trabalho">
            </div>
            <div class="form-group">
              <label for="zipCode">CEP:</label>
              <div class="zipcode-group">
                <input id="zipCode" type="text" formControlName="zipCode" placeholder="00000-000">
                <button type="button" (click)="searchZipCode()">Buscar</button>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="street">Rua:</label>
              <input id="street" type="text" formControlName="street">
            </div>
            <div class="form-group">
              <label for="number">Número:</label>
              <input id="number" type="text" formControlName="number">
            </div>
            <div class="form-group">
              <label for="complement">Complemento:</label>
              <input id="complement" type="text" formControlName="complement">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="neighborhood">Bairro:</label>
              <input id="neighborhood" type="text" formControlName="neighborhood">
            </div>
            <div class="form-group">
              <label for="city">Cidade:</label>
              <input id="city" type="text" formControlName="city">
            </div>
            <div class="form-group">
              <label for="state">Estado:</label>
              <input id="state" type="text" formControlName="state" maxlength="2">
            </div>
          </div>

          <div class="form-actions">
            <button type="button" (click)="addNewAddress()" class="btn-primary">
              Adicionar Endereço
            </button>
          </div>

          <div *ngIf="addressError" class="error-message">
            {{ addressError }}
          </div>
        </form>
      </div> -->
    </div>

    <div *ngIf="currentStep === 3" class="step-content">
      <h2>Forma de Pagamento</h2>
      
      <div *ngIf="cartSummary.paymentMethods.length > 0" class="payment-methods">
        <h3>Métodos de Pagamento</h3>
        <div *ngFor="let method of cartSummary.paymentMethods; let i = index" class="payment-method">
          <div class="method-info">
            <fa-icon [icon]="faCreditCard"></fa-icon>
            <span *ngIf="method.creditCards && method.creditCards.length > 0">
              Cartão terminado em {{ method.creditCards[0].cardNumber.slice(-4) }}
            </span>
            <span class="amount">{{ formatCurrency(method.totalAmount) }}</span>
          </div>
          <button type="button" (click)="removePaymentMethod(i)" class="remove-method">
            Remover
          </button>
        </div>
      </div>

      <div class="add-payment">
        <h3>Adicionar Método de Pagamento</h3>
        <form [formGroup]="paymentForm">
          <div class="form-group">
            <label>Tipo de Pagamento:</label>
            <select formControlName="paymentType">
              <option value="CREDIT_CARD">Cartão de Crédito</option>
            </select>
          </div>

          <div class="existing-cards">
            <div class="form-group">
              <label>Usar Cartão Cadastrado:</label>
              <select formControlName="creditCardId" (change)="onCreditCardChange()">
                <option value="">Selecione um cartão...</option>
                <option *ngFor="let card of clientCreditCards" [value]="card.id">
                  {{ formatCardNumber(card.cardNumber) }} - {{ card.cardHolder }}
                </option>
                <option value="NEW_CARD">➕ Adicionar novo cartão</option>
              </select>
              <small class="help-text" style="display: block; margin-top: 5px; color: #666;">
                Não tem cartão cadastrado? Selecione "➕ Adicionar novo cartão" para adicionar um novo.
              </small>
            </div>
            <small class="help-text" *ngIf="paymentForm.get('creditCardId')?.value === 'NEW_CARD'" style="color: #2196F3; font-weight: bold;">
              Você será redirecionado para adicionar um novo cartão no seu perfil. Após adicionar, volte ao checkout.
            </small>
          </div>

          <div class="form-group">
            <label for="amount">Valor:</label>
            <input id="amount" type="number" formControlName="amount" [value]="cartSummary.total" step="0.01">
          </div>

          <div class="form-actions">
            <button type="button" (click)="addPaymentMethod()" class="btn-primary">
              Adicionar Método
            </button>
          </div>

          <div *ngIf="paymentError" class="error-message">
            {{ paymentError }}
          </div>
        </form>
      </div>
    </div>

    <div *ngIf="currentStep === 4" class="step-content">
      <h2>Confirmação do Pedido</h2>
      
      <div class="confirmation-summary">
        <div class="summary-section">
          <h3>Cliente</h3>
          <p>{{ selectedClient?.nome }}</p>
          <p>{{ selectedClient?.email }}</p>
        </div>

        <div class="summary-section">
          <h3>Endereço de Entrega</h3>
          <p *ngIf="cartSummary.deliveryAddress">
            {{ cartSummary.deliveryAddress.name }}<br>
            {{ cartSummary.deliveryAddress.street }}, {{ cartSummary.deliveryAddress.number }}<br>
            <span *ngIf="cartSummary.deliveryAddress.complement">{{ cartSummary.deliveryAddress.complement }}<br></span>
            {{ cartSummary.deliveryAddress.neighborhood }} - {{ cartSummary.deliveryAddress.city }}/{{ cartSummary.deliveryAddress.state }}<br>
            CEP: {{ formatZipCode(cartSummary.deliveryAddress.zipCode) }}
          </p>
        </div>

        <div class="summary-section">
          <h3>Métodos de Pagamento</h3>
          <div *ngFor="let method of cartSummary.paymentMethods" class="payment-summary">
            <fa-icon [icon]="faCreditCard"></fa-icon>
            <span>{{ formatCurrency(method.totalAmount) }}</span>
          </div>
        </div>

        <div class="summary-section">
          <h3>Resumo Financeiro</h3>
          <div class="financial-summary">
            <div class="total-line">
              <span>Subtotal:</span>
              <span>{{ formatCurrency(cartSummary.subtotal) }}</span>
            </div>
            <div class="total-line" *ngIf="cartSummary.discount > 0">
              <span>Desconto:</span>
              <span class="discount">-{{ formatCurrency(cartSummary.discount) }}</span>
            </div>
            <div class="total-line">
              <span>Frete:</span>
              <span>{{ formatCurrency(cartSummary.shipping) }}</span>
            </div>
            <div class="total-line total">
              <span>Total:</span>
              <span>{{ formatCurrency(cartSummary.total) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="coupons-section">
      <h3>Aplicar Cupom</h3>
      <form [formGroup]="couponForm">
        <div class="coupon-input">
          <input type="text" formControlName="couponCode" placeholder="Digite o código do cupom">
          <button type="button" (click)="applyCoupon()" class="btn-secondary">
            Aplicar
          </button>
        </div>
        <div *ngIf="couponError" class="error-message">
          {{ couponError }}
        </div>
      </form>
    </div>

    <div class="step-navigation">
      <button 
        *ngIf="currentStep > 1" 
        type="button" 
        (click)="previousStep()" 
        class="btn-secondary">
        Voltar
      </button>
      
      <button 
        type="button" 
        (click)="cancelCheckout()" 
        class="btn-ghost"
        style="margin-right: auto;">
        Cancelar
      </button>
      
      <button 
        *ngIf="currentStep < totalSteps" 
        type="button" 
        (click)="nextStep()" 
        class="btn-primary">
        Próximo
      </button>
      
      <button 
        *ngIf="currentStep === totalSteps" 
        type="button" 
        (click)="finalizeOrder()" 
        [disabled]="isLoading"
        class="btn-success">
        <span *ngIf="isLoading">Processando...</span>
        <span *ngIf="!isLoading">Finalizar Pedido</span>
      </button>
    </div>
  </main>
</div>

